## SM4 的软件实现与优化

### 1. 引言

SM4（原名 SMS4）是中华人民共和国采用的一种分组密码标准，由国家密码管理局于 2012 年 3 月 21 日发布（标准编号 GM/T 0002-2012）。

* **用途**：商用密码体系中用于数据加密
* **参数**：分组长度与密钥长度均为 128 bit
* **结构**：加密与密钥扩展均采用 32 轮非线性迭代结构
* **S 盒**：固定的 8 比特输入 → 8 比特输出

---

### 2. SM4 算法流程

#### 2.1 密钥与参数

* 加密密钥：`MK = (MK0, MK1, MK2, MK3)`（4 × 4 Bytes）
* 轮密钥：`rk0, rk1, ..., rk31`（每个 32 bit）
* 系统参数：`FK1, FK2, FK3, FK4`
* 固定参数：`CK0, CK1, ..., CK31`

#### 2.2 加密过程

1. **32 轮迭代运算**：

   $$
   X_{i+4} = X_i \oplus T(X_{i+1} \oplus X_{i+2} \oplus X_{i+3} \oplus rk_i)
   $$

   其中 $T = L(\tau(\cdot))$，τ 为 S 盒替换，L 为线性变换。
2. **反序变换**：

   $$
   (Y_0, Y_1, Y_2, Y_3) = (X_{35}, X_{34}, X_{33}, X_{32})
   $$

#### 2.3 解密过程

结构与加密相同，但轮密钥使用顺序反向。

---

### 3. SM4 软件优化方法

#### 3.1 T-table 优化

* **原理**：将 S 盒替换与线性变换 L 合并为一次查表操作，减少位运算与循环移位。
* **优势**：

  * 4 字节并行处理
  * 减少约 75% 计算量
  * 内存访问模式规律，缓存友好
* **性能**：提升约 4 倍

#### 3.2 AES-NI 优化

* **原理**：

  * 将 SM4 S 盒映射为 AES S 盒形式
  * 使用 `AESENC` 指令完成核心变换
  * 通过仿射变换完成映射与逆映射
* **优势**：

  * 硬件指令单周期完成 S 盒操作
  * 128 位向量化，4 分组并行
  * 减少内存访问，对旁路攻击更安全
* **性能**：提升约 13.6 倍

#### 3.3 GFNI 优化（配合 AVX512）

* **原理**：

  * GFNI 指令集直接支持 GF(2⁸) 上的逆运算与仿射变换
  * 单条指令完成 S 盒核心操作
* **优势**：

  * 512 位向量化（16 分组并行）
  * 与 `VPROLD` 指令配合完成线性变换
  * 性能最高、功耗最低
* **性能**：提升约 47.5 倍

---

### 4. 性能对比（加密 1KB 数据）

| 优化技术          | 周期/字节 | 加速比   | 并行度 | 硬件要求    |
| ------------- | ----- | ----- | --- | ------- |
| 基础实现          | 28.5  | 1.0×  | 1   | 任何 x86  |
| T-table       | 7.2   | 4.0×  | 1   | 任何 x86  |
| AES-NI        | 2.1   | 13.6× | 4   | SSE4.1+ |
| GFNI + AVX512 | 0.6   | 47.5× | 16  | AVX512  |

---

## SM4-GCM 工作模式的优化实现

### 1. GCM 模式简介

* **特点**：结合 CTR 模式（加密）与 GHASH（认证）
* **安全性**：

  * CTR 提供机密性（唯一计数器值、不可预测密钥流）
  * GHASH 提供完整性（任何数据篡改都会导致验证失败）

---

### 2. 关键优化方法

#### 2.1 加密函数优化

* 用寄存器变量替代数组访问
* 循环展开（4 次）
* 直接输出结果，减少临时数组

#### 2.2 GF(2¹²⁸) 乘法优化

* 预计算全局 `R_table`
* `_byteswap_ulong` 加速字节序转换
* 优化边界处理，减少条件判断

#### 2.3 GHASH 优化

* 指针直接操作数据
* 分离完整块与部分块处理
* 预计算长度字段

#### 2.4 内存访问优化

* 局部变量存储轮密钥
* 减少临时容器创建
* `reserve` 预分配内存

#### 2.5 其他优化

* 常量 `constexpr`
* 位运算代替条件分支
* 合并相关计算

---

### 3. 实验结果

* 测试明文："SDUCST"
* 优化版本加密时间显著优于基础版本（参考图 `project1-b` 与 `project1-b-基础版本`）

---

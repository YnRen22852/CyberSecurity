## SM2 软件实现优化

### 一、SM2 基础实现

#### 1. 核心数学原理

SM2 安全性依赖于 **椭圆曲线离散对数问题**：已知椭圆曲线点 $P$ 和 $Q = kP$，在计算上无法求出 $k$。
数学基础包括：

* **有限域运算**：素域 $F_p$ 上的加法、乘法、逆运算
* **椭圆曲线方程**：标准形式

  $$
  y^2 = x^3 + ax + b \pmod{p}
  $$

  推荐参数：256 位素数域
* **点运算**：点加 $P+Q$、倍点 $2P$ 和标量乘 $kP$ 构成核心运算

#### 2. 数字签名

**签名生成**

1. 计算哈希值

   $$
   e = \text{HASH}(Z_A \Vert M)
   $$
2. 选随机数 $k \in [1,n-1]$，计算 $(x_1,y_1) = kG$
3. $r = (e + x_1) \bmod n$，若 $r=0$ 重新选 $k$
4. $$
   s = (1+d_A)^{-1} \cdot (k - r d_A) \bmod n
   $$

   输出 $(r,s)$

**签名验证**

1. 验证 $r,s \in [1,n-1]$
2. 计算 $t = (r+s) \bmod n$
3. 计算 $(x_1,y_1) = sG + tP_A$
4. 验证

   $$
   r \equiv (e + x_1) \bmod n
   $$

#### 3. 加密与解密

**加密**

1. 生成随机数 $k$，计算 $C_1 = kG$
2. 计算 $S = hP_B$，若 $S$ 为无穷远点报错
3. 计算 $(x_2,y_2) = kP_B$，用 KDF 生成密钥 $t$
4. $C_2 = M \oplus t$，$C_3 = \text{HASH}(x_2 \Vert M \Vert y_2)$
5. 输出 $C = C_1 \Vert C_3 \Vert C_2$

**解密**

1. 验证 $C_1$ 在曲线上，计算 $S = hC_1$
2. 计算 $(x_2,y_2) = d_B C_1$，生成 $t = \text{KDF}(x_2 \Vert y_2)$
3. 还原 $M' = C_2 \oplus t$，验证 $C_3$ 是否匹配

---

### 二、代码实现与关键技术

#### 1. SM3 哈希算法

* **功能**：输出 256 位哈希值
* **流程**：

  * 消息填充（按标准补位）
  * 消息扩展（512 位分组扩展为 132 个 32 位字）
  * 压缩函数（8 个状态变量、64 轮迭代）
  * 轮函数（FF/GG 与 P0/P1 置换）
  * 32 位循环左移（位运算实现）

#### 2. SM2 椭圆曲线加密

* **参数**：sm2p256v1 曲线
* **点运算**：

  * `_point_add()`：点加
  * `_scalar_mult()`：高效标量乘法（倍点算法）
* **KDF**：基于 SM3

**加密流程**：

1. 随机数 $k$
2. $C_1 = kG$，$kP_B = (x_2,y_2)$
3. 生成 $t$ → 得 $C_2, C_3$

**解密流程**：

1. 从 $C_1$ 还原点坐标
2. $d \cdot C_1 = (x_2,y_2)$ → 生成 $t$
3. 恢复消息并校验哈希

---

### 三、优化策略

* **模块化设计**：SM2 与 SM3 独立实现，可单独调用
* **算法优化**：

  * 高效倍点算法
  * 优化点加与点加倍
  * 减少大整数运算

---

### 四、签名算法误用与攻击验证（PoC）

#### 1. 泄露 k

$$
d = r^{-1}(ks - e)
$$

#### 2. 重用 k（同用户不同消息）

$$
k = \frac{e_1 - e_2}{s_1 - s_2},\quad d = \frac{s_1 k - e_1}{r}
$$

#### 3. 不同用户相同 k

$$
d_1 - d_2 = \frac{(s_1 - s_2)k - (e_1 - e_2)}{r}
$$

#### 4. 混合签名泄露

在 ECDSA 与 Schnorr 中混用同一 k，可推导出：

$$
d = \frac{s_S s_E - e}{r + e_s s_E}
$$

---

### 五、案例：伪造“中本聪”签名

1. 从区块链获取两个 r 相同的签名
2. 计算

   $$
   k = \frac{e_1 - e_2}{s_1 - s_2}
   $$
3. 计算

   $$
   d = \frac{s_1 k - e_1}{r}
   $$
4. 用恢复的私钥伪造新签名

---

### 六、实验结果

* SM2 基础实验结果：见 **project5-a.png**
* 签名算法误用实验结果：见 **project5-b.png**
* 中本聪签名伪造实验结果：见 **project5-c.png**

---

